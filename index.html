<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory & Requisition (Static SPA)</title>

  <!-- Bootstrap 5 (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root {
      --app-bg: #f6f7fb;
      --card-shadow: 0 6px 20px rgba(0,0,0,0.06);
      --border-soft: rgba(0,0,0,0.08);
    }
    body { background: var(--app-bg); }
    .app-brand { letter-spacing: 0.2px; }
    .card { box-shadow: var(--card-shadow); border-color: var(--border-soft); }
    .table thead th { white-space: nowrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Section loading overlay */
    .section-wrap { position: relative; }
    .section-overlay {
      display: none;
      position: absolute; inset: 0;
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(1px);
      z-index: 10;
      align-items: center; justify-content: center;
    }
    .section-overlay.show { display: flex; }
    .section-overlay .spinner-border { width: 3rem; height: 3rem; }

    /* XSS-safe rendering: allow long text wrap */
    .wrap-anywhere { overflow-wrap: anywhere; word-break: break-word; }

    /* Nav active */
    .nav-link.active { font-weight: 600; }

    /* Small helpers */
    .kpi-title { font-size: .85rem; color: #6c757d; }
    .kpi-value { font-size: 1.6rem; font-weight: 700; }
    .badge-soft {
      background: rgba(13,110,253,0.12);
      color: #0d6efd;
      border: 1px solid rgba(13,110,253,0.25);
    }
    .row-gap-2 { row-gap: .75rem; }

    /* Highlight low stock rows */
    .low-stock { background: rgba(220,53,69,0.08) !important; }

    /* Fixed toast area */
    .toast-container { z-index: 11000; }

    /* Offcanvas width for better mobile UX */
    .offcanvas { width: 320px; }

    /* Make tables scrollable on mobile */
    .table-responsive { border-radius: .5rem; }

    /* Required field marker */
    .req::after { content:" *"; color:#dc3545; font-weight:700; }
  </style>
</head>

<body>
  <!-- Top Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <button class="btn btn-outline-light me-2 d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#appOffcanvas">
        <i class="bi bi-list"></i>
      </button>
      <a class="navbar-brand app-brand" href="#" id="brandHome">
        <i class="bi bi-box-seam me-2"></i>Inventory
      </a>

      <div class="d-none d-lg-flex align-items-center gap-2 ms-auto">
        <div class="form-check form-switch text-white mb-0 me-2" title="Admin mode (แสดงเมนู Masters)">
          <input class="form-check-input" type="checkbox" role="switch" id="adminModeSwitch">
          <label class="form-check-label small" for="adminModeSwitch">Admin mode</label>
        </div>
        <button class="btn btn-outline-light btn-sm" id="btnSettingsTop">
          <i class="bi bi-gear"></i> Settings
        </button>
      </div>
    </div>
  </nav>

  <!-- Offcanvas Nav (mobile) -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="appOffcanvas">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title"><i class="bi bi-box-seam me-2"></i>Inventory</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" role="switch" id="adminModeSwitchMobile">
          <label class="form-check-label" for="adminModeSwitchMobile">Admin mode</label>
        </div>
        <button class="btn btn-outline-secondary btn-sm" id="btnSettingsMobile">
          <i class="bi bi-gear"></i>
        </button>
      </div>

      <ul class="nav nav-pills flex-column gap-1" id="navListMobile">
        <li class="nav-item"><a class="nav-link" href="#" data-page="dashboard"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-page="requisitions"><i class="bi bi-file-earmark-text me-2"></i>Requisitions</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-page="stock"><i class="bi bi-archive me-2"></i>Stock</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-page="transactions"><i class="bi bi-arrow-left-right me-2"></i>Transactions</a></li>
        <li class="nav-item d-none" id="navMastersMobile"><a class="nav-link" href="#" data-page="masters"><i class="bi bi-database me-2"></i>Masters</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-page="settings"><i class="bi bi-gear me-2"></i>Settings</a></li>
      </ul>
    </div>
  </div>

  <!-- Main container -->
  <main class="container-fluid py-3">
    <!-- Global banners -->
    <div class="row row-gap-2">
      <div class="col-12">
        <div class="alert alert-warning d-none" id="bannerConfigMissing" role="alert">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <i class="bi bi-exclamation-triangle me-2"></i>
              ยังไม่ได้ตั้งค่า <b>GAS_WEB_APP_URL</b> และ/หรือ <b>apiKey</b>. กรุณาเปิด Settings ก่อนใช้งาน
            </div>
            <button class="btn btn-dark btn-sm" id="btnOpenSettingsBanner"><i class="bi bi-gear me-1"></i>Open Settings</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Pages -->
    <div class="section-wrap">
      <div class="section-overlay" id="overlayGlobal">
        <div class="text-center">
          <div class="spinner-border" role="status" aria-label="loading"></div>
          <div class="mt-2 small text-muted">Loading...</div>
        </div>
      </div>

      <!-- Dashboard -->
      <section id="page-dashboard" class="app-page d-none">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div>
            <h4 class="mb-0">Dashboard</h4>
            <div class="small text-muted">Polling ทุก 5 วินาที (dashboard_snapshot)</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <div class="small text-muted">
              <span class="me-2">Last sync:</span>
              <span class="badge badge-soft mono" id="dashLastSync">-</span>
            </div>
            <button class="btn btn-outline-primary btn-sm" id="btnDashboardRefresh">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
        </div>

        <div class="alert alert-danger d-none" id="dashErrorBanner" role="alert"></div>

        <div class="row row-gap-2">
          <div class="col-12 col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="kpi-title">Active Items</div>
                <div class="kpi-value" id="kpiActiveItems">-</div>
                <div class="small text-muted">รวมรายการที่ active</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="kpi-title">Total On-hand</div>
                <div class="kpi-value" id="kpiTotalOnHand">-</div>
                <div class="small text-muted">รวมยอดคงเหลือ (ทุกคลัง)</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="kpi-title">Low Stock Lines</div>
                <div class="kpi-value" id="kpiLowStockLines">-</div>
                <div class="small text-muted">ต่ำกว่า minimum</div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-3">
            <div class="card">
              <div class="card-body">
                <div class="kpi-title">Last Updated</div>
                <div class="kpi-value fs-5 mono" id="kpiLastUpdated">-</div>
                <div class="small text-muted">เวลาจาก server</div>
              </div>
            </div>
          </div>
        </div>

        <div class="row row-gap-2 mt-1">
          <div class="col-12 col-lg-6">
            <div class="card">
              <div class="card-header bg-white d-flex align-items-center justify-content-between">
                <div><i class="bi bi-exclamation-circle me-2 text-danger"></i>Low Stock Top 20</div>
                <button class="btn btn-outline-secondary btn-sm" id="btnLoadStockForDash">
                  <i class="bi bi-box"></i> Use Stock Summary
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm table-hover align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th>Warehouse</th>
                        <th class="text-end">On-hand</th>
                        <th class="text-end">Min</th>
                      </tr>
                    </thead>
                    <tbody id="dashLowStockTbody">
                      <tr><td colspan="4" class="text-center text-muted py-4">No data</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="small text-muted mt-2">
                  หมายเหตุ: หาก backend ไม่ส่ง lowStockTop20 จะใช้ข้อมูลจาก Stock Summary เมื่อกดปุ่มด้านบน
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-6">
            <div class="card">
              <div class="card-header bg-white">
                <i class="bi bi-graph-down-arrow me-2"></i>Top Issue Top 10
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm table-hover align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Item</th>
                        <th class="text-end">Qty Issued</th>
                        <th>Period</th>
                      </tr>
                    </thead>
                    <tbody id="dashTopIssueTbody">
                      <tr><td colspan="3" class="text-center text-muted py-4">No data</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="small text-muted mt-2">
                  หมายเหตุ: หาก backend ไม่ส่ง topIssueTop10 ตารางนี้จะแสดงว่าง
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Requisitions -->
      <section id="page-requisitions" class="app-page d-none">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div>
            <h4 class="mb-0">Requisitions</h4>
            <div class="small text-muted">สร้าง DRAFT → Submit (สร้าง PDF + ส่งอีเมล)</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnReqReloadMasters">
              <i class="bi bi-arrow-repeat"></i> Reload master data
            </button>
            <button class="btn btn-outline-primary btn-sm" id="btnReqRefreshList">
              <i class="bi bi-arrow-clockwise"></i> Refresh list
            </button>
          </div>
        </div>

        <div class="row row-gap-2">
          <div class="col-12 col-xl-7">
            <div class="card">
              <div class="card-header bg-white d-flex align-items-center justify-content-between">
                <div><i class="bi bi-list-check me-2"></i>Requisition List</div>
                <div class="d-flex align-items-center gap-2">
                  <select class="form-select form-select-sm" id="reqFilterStatus" style="width: 180px;">
                    <option value="">All statuses</option>
                    <option value="DRAFT">DRAFT</option>
                    <option value="SUBMITTED">SUBMITTED</option>
                    <option value="PICKED">PICKED</option>
                    <option value="ISSUED">ISSUED</option>
                    <option value="COMPLETED">COMPLETED</option>
                  </select>
                </div>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm table-hover align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Req ID</th>
                        <th>Dept</th>
                        <th>Status</th>
                        <th class="text-nowrap">Req datetime</th>
                        <th class="text-end">PDF</th>
                      </tr>
                    </thead>
                    <tbody id="reqListTbody">
                      <tr><td colspan="5" class="text-center text-muted py-4">No data</td></tr>
                    </tbody>
                  </table>
                </div>
                <div class="small text-muted mt-2">
                  คลิกแถวเพื่อดูรายละเอียด
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-xl-5">
            <div class="card">
              <div class="card-header bg-white d-flex align-items-center justify-content-between">
                <div><i class="bi bi-file-earmark-plus me-2"></i>Create Requisition</div>
                <div class="small text-muted">
                  Current: <span class="badge text-bg-secondary mono" id="reqCurrentId">-</span>
                </div>
              </div>
              <div class="card-body">
                <form id="formReqHeader" novalidate>
                  <div class="row g-2">
                    <div class="col-12">
                      <label class="form-label req">Dept</label>
                      <input class="form-control" name="dept" required placeholder="เช่น ICU" />
                      <div class="invalid-feedback">กรุณากรอก Dept</div>
                    </div>

                    <div class="col-12 col-md-6">
                      <label class="form-label req">Requester</label>
                      <input class="form-control" name="requester" required placeholder="ชื่อผู้ขอ" />
                      <div class="invalid-feedback">กรุณากรอก requester</div>
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label req">Requester Email</label>
                      <input class="form-control" name="requester_email" required placeholder="name@org.com" />
                      <div class="invalid-feedback">อีเมลไม่ถูกต้อง</div>
                    </div>

                    <div class="col-12 col-md-6">
                      <label class="form-label">Approver</label>
                      <input class="form-control" name="approver" placeholder="(optional)" />
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label">Approver Email</label>
                      <input class="form-control" name="approver_email" placeholder="(optional)" />
                      <div class="invalid-feedback">อีเมลไม่ถูกต้อง</div>
                    </div>

                    <div class="col-12">
                      <label class="form-label">Remark</label>
                      <textarea class="form-control" name="remark" rows="2" placeholder="หมายเหตุ"></textarea>
                    </div>
                  </div>

                  <hr class="my-3">

                  <div class="d-flex align-items-center justify-content-between">
                    <div class="fw-semibold"><i class="bi bi-card-list me-2"></i>Lines</div>
                    <button class="btn btn-outline-secondary btn-sm" type="button" id="btnAddReqLine">
                      <i class="bi bi-plus-circle"></i> Add line
                    </button>
                  </div>

                  <div class="table-responsive mt-2">
                    <table class="table table-sm align-middle" id="reqLinesTable">
                      <thead>
                        <tr>
                          <th style="width: 210px;">Item</th>
                          <th style="width: 90px;" class="text-end">Qty</th>
                          <th style="width: 90px;">UOM</th>
                          <th>Remark</th>
                          <th style="width: 40px;"></th>
                        </tr>
                      </thead>
                      <tbody id="reqLinesTbody">
                        <!-- dynamic -->
                      </tbody>
                    </table>
                  </div>

                  <div class="d-flex flex-wrap gap-2 mt-2">
                    <button class="btn btn-outline-primary" type="button" id="btnSaveDraft">
                      <i class="bi bi-save"></i> Save Draft
                    </button>
                    <button class="btn btn-primary" type="button" id="btnSubmitReq">
                      <i class="bi bi-send"></i> Submit
                    </button>
                  </div>

                  <div class="alert alert-success d-none mt-3" id="reqSubmitSuccess"></div>
                  <div class="alert alert-danger d-none mt-3" id="reqSubmitError"></div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Stock -->
      <section id="page-stock" class="app-page d-none">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div>
            <h4 class="mb-0">Stock</h4>
            <div class="small text-muted">แสดงจาก get_stock_summary</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnStockReloadMasters">
              <i class="bi bi-arrow-repeat"></i> Reload master data
            </button>
            <button class="btn btn-outline-primary btn-sm" id="btnStockRefresh">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-4">
                <label class="form-label">Search item_code / name</label>
                <input class="form-control" id="stockSearch" placeholder="เช่น ITM001 หรือ ถุงมือ" />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label">Warehouse</label>
                <select class="form-select" id="stockWarehouse">
                  <option value="">All</option>
                </select>
              </div>
              <div class="col-12 col-md-3">
                <div class="form-check mt-4 pt-2">
                  <input class="form-check-input" type="checkbox" id="stockLowOnly">
                  <label class="form-check-label" for="stockLowOnly">Low stock only</label>
                </div>
              </div>
              <div class="col-12 col-md-2">
                <button class="btn btn-outline-secondary w-100" id="btnStockClear">
                  <i class="bi bi-x-circle"></i> Clear
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-white d-flex align-items-center justify-content-between">
            <div><i class="bi bi-archive me-2"></i>Stock Summary</div>
            <div class="small text-muted">Rows: <span class="mono" id="stockRowCount">0</span></div>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Warehouse</th>
                    <th class="text-end">On-hand</th>
                    <th class="text-end">Min</th>
                    <th class="text-nowrap">Updated</th>
                  </tr>
                </thead>
                <tbody id="stockTbody">
                  <tr><td colspan="5" class="text-center text-muted py-4">No data</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- Transactions -->
      <section id="page-transactions" class="app-page d-none">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div>
            <h4 class="mb-0">Transactions</h4>
            <div class="small text-muted">Receive / Issue</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnTxnReloadMasters">
              <i class="bi bi-arrow-repeat"></i> Reload master data
            </button>
            <button class="btn btn-outline-primary btn-sm" id="btnTxnRefreshStock">
              <i class="bi bi-arrow-clockwise"></i> Refresh stock
            </button>
          </div>
        </div>

        <div class="row row-gap-2">
          <div class="col-12 col-lg-6">
            <div class="card">
              <div class="card-header bg-white"><i class="bi bi-box-arrow-in-down me-2"></i>Receive (create_receipt)</div>
              <div class="card-body">
                <form id="formReceive" novalidate>
                  <div class="row g-2">
                    <div class="col-12 col-md-6">
                      <label class="form-label">Ref No</label>
                      <input class="form-control" name="ref_no" placeholder="PO-0001" />
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label req">Created by</label>
                      <input class="form-control" name="created_by" required placeholder="store" />
                      <div class="invalid-feedback">กรุณากรอก created_by</div>
                    </div>

                    <div class="col-12">
                      <label class="form-label req">Item</label>
                      <select class="form-select" name="item_code" required></select>
                      <div class="invalid-feedback">กรุณาเลือก item</div>
                    </div>

                    <div class="col-12 col-md-6">
                      <label class="form-label req">Warehouse</label>
                      <select class="form-select" name="warehouse_code" required></select>
                      <div class="invalid-feedback">กรุณาเลือก warehouse</div>
                    </div>
                    <div class="col-12 col-md-3">
                      <label class="form-label req">Qty</label>
                      <input class="form-control text-end" name="qty" required inputmode="decimal" placeholder="0" />
                      <div class="invalid-feedback">qty ต้องมากกว่า 0</div>
                    </div>
                    <div class="col-12 col-md-3">
                      <label class="form-label req">UOM</label>
                      <input class="form-control" name="uom" required placeholder="เช่น ชิ้น" />
                      <div class="invalid-feedback">กรุณากรอก uom</div>
                    </div>

                    <div class="col-12 col-md-6">
                      <label class="form-label">Unit cost (optional)</label>
                      <input class="form-control text-end" name="unit_cost" inputmode="decimal" placeholder="0.00" />
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label">Remark</label>
                      <input class="form-control" name="remark" placeholder="หมายเหตุ" />
                    </div>
                  </div>

                  <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-success" type="submit">
                      <i class="bi bi-check-circle"></i> Create receipt
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="btnReceiveClear">
                      <i class="bi bi-eraser"></i> Clear
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-6">
            <div class="card">
              <div class="card-header bg-white"><i class="bi bi-box-arrow-up me-2"></i>Issue (create_issue)</div>
              <div class="card-body">
                <form id="formIssue" novalidate>
                  <div class="row g-2">
                    <div class="col-12 col-md-6">
                      <label class="form-label">Ref No</label>
                      <input class="form-control" name="ref_no" placeholder="ISS-0001" />
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label req">Created by</label>
                      <input class="form-control" name="created_by" required placeholder="store" />
                      <div class="invalid-feedback">กรุณากรอก created_by</div>
                    </div>

                    <div class="col-12">
                      <label class="form-label req">Item</label>
                      <select class="form-select" name="item_code" required></select>
                      <div class="invalid-feedback">กรุณาเลือก item</div>
                    </div>

                    <div class="col-12 col-md-6">
                      <label class="form-label req">Warehouse</label>
                      <select class="form-select" name="warehouse_code" required></select>
                      <div class="invalid-feedback">กรุณาเลือก warehouse</div>
                    </div>
                    <div class="col-12 col-md-3">
                      <label class="form-label req">Qty</label>
                      <input class="form-control text-end" name="qty" required inputmode="decimal" placeholder="0" />
                      <div class="invalid-feedback">qty ต้องมากกว่า 0</div>
                    </div>
                    <div class="col-12 col-md-3">
                      <label class="form-label req">UOM</label>
                      <input class="form-control" name="uom" required placeholder="เช่น ชิ้น" />
                      <div class="invalid-feedback">กรุณากรอก uom</div>
                    </div>

                    <div class="col-12 col-md-6">
                      <label class="form-label">Dept</label>
                      <input class="form-control" name="dept" placeholder="เช่น ER" />
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label">Requester</label>
                      <input class="form-control" name="requester" placeholder="ชื่อผู้ขอ" />
                    </div>

                    <div class="col-12">
                      <label class="form-label">Remark</label>
                      <input class="form-control" name="remark" placeholder="หมายเหตุ" />
                    </div>
                  </div>

                  <div class="d-flex gap-2 mt-3">
                    <button class="btn btn-danger" type="submit">
                      <i class="bi bi-check-circle"></i> Create issue
                    </button>
                    <button class="btn btn-outline-secondary" type="button" id="btnIssueClear">
                      <i class="bi bi-eraser"></i> Clear
                    </button>
                  </div>

                  <div class="alert alert-warning d-none mt-3" id="issueInsufficientBanner"></div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Masters (Admin) -->
      <section id="page-masters" class="app-page d-none">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div>
            <h4 class="mb-0">Masters</h4>
            <div class="small text-muted">Items / Vendors / Warehouses (Admin mode)</div>
          </div>
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnMastersReload">
              <i class="bi bi-arrow-repeat"></i> Reload master data
            </button>
            <button class="btn btn-outline-primary btn-sm" id="btnAddMaster">
              <i class="bi bi-plus-circle"></i> Add
            </button>
          </div>
        </div>

        <ul class="nav nav-tabs" id="mastersTabs">
          <li class="nav-item"><a class="nav-link active" href="#" data-master="items">Items</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-master="vendors">Vendors</a></li>
          <li class="nav-item"><a class="nav-link" href="#" data-master="warehouses">Warehouses</a></li>
        </ul>

        <div class="card border-top-0 rounded-top-0">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead id="mastersThead"></thead>
                <tbody id="mastersTbody">
                  <tr><td class="text-center text-muted py-4">No data</td></tr>
                </tbody>
              </table>
            </div>
            <div class="small text-muted mt-2">
              คลิกปุ่ม <b>Edit</b> เพื่อแก้ไข
            </div>
          </div>
        </div>
      </section>

      <!-- Settings page (quick link) -->
      <section id="page-settings" class="app-page d-none">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
          <div>
            <h4 class="mb-0">Settings</h4>
            <div class="small text-muted">ตั้งค่า GAS URL และ apiKey (บันทึกใน localStorage)</div>
          </div>
          <button class="btn btn-primary" id="btnOpenSettingsPage">
            <i class="bi bi-gear"></i> Open Settings
          </button>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="row g-2">
              <div class="col-12 col-lg-8">
                <div class="small text-muted">Current GAS Web App URL</div>
                <div class="mono wrap-anywhere" id="currentGasUrl">-</div>
              </div>
              <div class="col-12 col-lg-4">
                <div class="small text-muted">API Key</div>
                <div class="mono" id="currentApiKey">-</div>
              </div>
            </div>

            <hr>
            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-outline-primary" id="btnTestConnectionPage">
                <i class="bi bi-plug"></i> Test Connection
              </button>
              <button class="btn btn-outline-secondary" id="btnReloadMastersPage">
                <i class="bi bi-arrow-repeat"></i> Reload master data
              </button>
            </div>

            <div class="alert alert-success d-none mt-3" id="settingsTestOk"></div>
            <div class="alert alert-danger d-none mt-3" id="settingsTestFail"></div>
          </div>
        </div>
      </section>
    </div>

    <footer class="text-center text-muted small mt-4">
      <div>Static SPA • Bootstrap 5 • Google Apps Script JSON API</div>
    </footer>
  </main>

  <!-- Toasts -->
  <div class="toast-container position-fixed top-0 end-0 p-3">
    <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">-</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal fade" id="modalSettings" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-gear me-2"></i>Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="btnSettingsClose"></button>
        </div>
        <div class="modal-body">
          <form id="formSettings" novalidate>
            <div class="row g-2">
              <div class="col-12">
                <label class="form-label req">GAS_WEB_APP_URL</label>
                <input class="form-control" name="gasUrl" required placeholder="https://script.google.com/macros/s/.../exec" />
                <div class="invalid-feedback">กรุณากรอก URL</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label req">apiKey</label>
                <input class="form-control" name="apiKey" required placeholder="API_KEY" />
                <div class="invalid-feedback">กรุณากรอก apiKey</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Admin mode</label>
                <select class="form-select" name="adminMode">
                  <option value="false">Off</option>
                  <option value="true">On</option>
                </select>
              </div>
            </div>

            <hr class="my-3">

            <div class="d-flex flex-wrap gap-2">
              <button class="btn btn-outline-primary" type="button" id="btnTestConnection">
                <i class="bi bi-plug"></i> Test Connection
              </button>
              <button class="btn btn-success" type="submit">
                <i class="bi bi-check-circle"></i> Save
              </button>
              <button class="btn btn-outline-secondary" type="button" id="btnClearSettings">
                <i class="bi bi-trash"></i> Clear localStorage
              </button>
            </div>

            <div class="alert alert-success d-none mt-3" id="settingsOk"></div>
            <div class="alert alert-danger d-none mt-3" id="settingsFail"></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirm Submit Requisition Modal -->
  <div class="modal fade" id="modalConfirmSubmit" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-shield-check me-2"></i>Confirm Submit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-2">คุณต้องการ Submit requisition นี้หรือไม่?</div>
          <ul class="small text-muted mb-0">
            <li>ระบบจะสร้าง PDF และอัปโหลดไป Google Drive</li>
            <li>ระบบจะส่งอีเมลแนบ PDF ตามการตั้งค่า backend</li>
          </ul>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="btnConfirmSubmitNow">
            <i class="bi bi-send"></i> Submit now
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Requisition Detail Modal -->
  <div class="modal fade" id="modalReqDetail" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>Requisition Detail</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="reqDetailHeader" class="mb-3"></div>
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Item</th>
                  <th class="text-end">Qty</th>
                  <th>UOM</th>
                  <th>Remark</th>
                </tr>
              </thead>
              <tbody id="reqDetailLines">
                <tr><td colspan="4" class="text-center text-muted py-4">No data</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <a class="btn btn-outline-primary d-none" target="_blank" rel="noopener" id="btnReqOpenPdf">
            <i class="bi bi-box-arrow-up-right"></i> Open PDF
          </a>
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Master Create/Edit Modal -->
  <div class="modal fade" id="modalMasterEdit" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i><span id="masterModalTitle">Edit</span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formMaster" novalidate>
            <div id="masterFormFields" class="row g-2"></div>
            <div class="alert alert-danger d-none mt-3" id="masterSaveError"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="btnMasterSave">
            <i class="bi bi-check-circle"></i> Save
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**************************************************************************
     * App (Single-file SPA)
     * - API: fetch POST with Content-Type: text/plain;charset=utf-8
     * - Body: JSON.stringify({ action, data, apiKey })
     * - Polling: every 5 seconds dashboard_snapshot
     * - Client cache: in-memory + localStorage optional
     * - XSS protection: escapeHTML on any render
     **************************************************************************/

    const STORAGE_KEYS = {
      settings: "invapp.settings.v1",
      mastersCache: "invapp.mastersCache.v1",
      adminMode: "invapp.adminMode.v1",
    };

    const state = {
      config: { gasUrl: "", apiKey: "", adminMode: false },
      ui: { currentPage: "dashboard", mastersTab: "items", polling: null, lastSync: null },
      cache: {
        masters: {
          items: [],
          vendors: [],
          warehouses: [],
          loadedAt: null
        },
        stockSummary: null,
        dashboard: null,
      },
      current: {
        requisitionDraft: { req_id: null },
        masterEdit: { type: "items", mode: "create", record: null }
      }
    };

    // --------- DOM helpers ----------
    const $ = (sel, root = document) => root.querySelector(sel);
    const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

    function escapeHTML(str) {
      if (str === null || str === undefined) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    function fmtISO(ts) {
      try {
        const d = ts ? new Date(ts) : null;
        if (!d || isNaN(d)) return "-";
        return d.toISOString().replace("T"," ").slice(0,19);
      } catch { return "-"; }
    }

    function toNumber(v) {
      if (v === null || v === undefined || v === "") return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function showToast(message, type = "info") {
      // type: success | error | info
      const toastEl = $("#appToast");
      const bodyEl = $("#toastBody");
      bodyEl.innerHTML = escapeHTML(message);

      toastEl.classList.remove("text-bg-dark","text-bg-success","text-bg-danger","text-bg-info");
      toastEl.classList.add(type === "success" ? "text-bg-success"
                      : type === "error" ? "text-bg-danger"
                      : type === "info" ? "text-bg-info"
                      : "text-bg-dark");
      const toast = bootstrap.Toast.getOrCreateInstance(toastEl, { delay: 2500 });
      toast.show();
    }

    function showOverlay(show, overlayId = "overlayGlobal") {
      const el = $("#" + overlayId);
      if (!el) return;
      el.classList.toggle("show", !!show);
    }

    function setBannerConfigMissing(show) {
      $("#bannerConfigMissing").classList.toggle("d-none", !show);
    }

    // --------- API module ----------
    const api = {
      async call(action, data = {}) {
        if (!state.config.gasUrl) throw new Error("MISSING_GAS_URL");
        const payload = { action, data, apiKey: state.config.apiKey || "" };

        const resp = await fetch(state.config.gasUrl, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        // GAS returns JSON text; if not, throw
        const text = await resp.text();
        let json;
        try { json = JSON.parse(text); }
        catch { throw new Error("INVALID_SERVER_RESPONSE"); }

        if (!json.ok) {
          // Preserve server error string
          const err = json.error || "UNKNOWN_ERROR";
          const e = new Error(err);
          e.serverTime = json.serverTime;
          e.data = json.data;
          throw e;
        }
        return json;
      }
    };

    // --------- Settings ----------
    function loadSettingsFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.settings);
        if (!raw) return;
        const s = JSON.parse(raw);
        state.config.gasUrl = String(s.gasUrl || "");
        state.config.apiKey = String(s.apiKey || "");
        state.config.adminMode = !!s.adminMode;
      } catch {}
    }

    function saveSettingsToStorage() {
      localStorage.setItem(STORAGE_KEYS.settings, JSON.stringify({
        gasUrl: state.config.gasUrl,
        apiKey: state.config.apiKey,
        adminMode: state.config.adminMode
      }));
    }

    function applyAdminModeToUI() {
      const show = !!state.config.adminMode;

      // Desktop switches
      $("#adminModeSwitch").checked = show;
      $("#adminModeSwitchMobile").checked = show;

      // Mobile nav Masters
      $("#navMastersMobile").classList.toggle("d-none", !show);

      // If current page is masters but admin off -> redirect
      if (!show && state.ui.currentPage === "masters") {
        navigate("dashboard");
      }
    }

    function openSettingsModal(force = false) {
      const modalEl = $("#modalSettings");
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl, {
        backdrop: force ? "static" : true,
        keyboard: !force
      });

      // Fill form
      const form = $("#formSettings");
      form.gasUrl.value = state.config.gasUrl || "";
      form.apiKey.value = state.config.apiKey || "";
      form.adminMode.value = state.config.adminMode ? "true" : "false";

      // Reset messages
      hideSettingsMessages();
      clearFormValidation(form);

      // Close button behavior on force
      $("#btnSettingsClose").disabled = !!force;

      modal.show();
    }

    function hideSettingsMessages() {
      $("#settingsOk").classList.add("d-none");
      $("#settingsFail").classList.add("d-none");
      $("#settingsTestOk").classList.add("d-none");
      $("#settingsTestFail").classList.add("d-none");
      $("#settingsOk").innerHTML = "";
      $("#settingsFail").innerHTML = "";
      $("#settingsTestOk").innerHTML = "";
      $("#settingsTestFail").innerHTML = "";
    }

    async function testConnection(targetOkEl, targetFailEl) {
      try {
        showOverlay(true);
        const res = await api.call("health", {});
        const data = res.data || {};
        const msg = `Connected: ${escapeHTML(data.status || "ok")} | DB: ${escapeHTML(data.dbSpreadsheetId || "-")} | TZ: ${escapeHTML(data.serverTimezone || "-")}`;
        targetOkEl.classList.remove("d-none");
        targetOkEl.innerHTML = `<i class="bi bi-check-circle me-2"></i>${msg}`;
        targetFailEl.classList.add("d-none");
        showToast("Connection OK", "success");
        return true;
      } catch (e) {
        targetFailEl.classList.remove("d-none");
        targetFailEl.innerHTML = `<i class="bi bi-x-circle me-2"></i>${escapeHTML(e.message)}`;
        targetOkEl.classList.add("d-none");
        showToast("Connection failed", "error");
        return false;
      } finally {
        showOverlay(false);
      }
    }

    function isConfigured() {
      return !!(state.config.gasUrl && state.config.apiKey);
    }

    function renderSettingsPageSummary() {
      $("#currentGasUrl").innerHTML = escapeHTML(state.config.gasUrl || "-");
      $("#currentApiKey").innerHTML = state.config.apiKey ? "••••••••" : "-";
      $("#settingsTestOk").classList.add("d-none");
      $("#settingsTestFail").classList.add("d-none");
    }

    // --------- Navigation ----------
    function navigate(page) {
      // Block use if not configured, except settings
      if (!isConfigured() && page !== "settings") {
        setBannerConfigMissing(true);
        openSettingsModal(true);
        return;
      }

      state.ui.currentPage = page;

      // Hide all pages
      $$(".app-page").forEach(el => el.classList.add("d-none"));
      const pageEl = $("#page-" + page);
      if (pageEl) pageEl.classList.remove("d-none");

      // Update active nav
      $$("#navListMobile .nav-link").forEach(a => {
        a.classList.toggle("active", a.dataset.page === page);
      });

      // Close offcanvas (mobile) if open
      const offcanvasEl = $("#appOffcanvas");
      const oc = bootstrap.Offcanvas.getInstance(offcanvasEl);
      if (oc) oc.hide();

      // Page-specific load
      if (page === "dashboard") {
        startPolling();
      } else {
        // Polling always runs per requirement, but we can keep running in background
        // Requirement: polling every 5 seconds. We'll keep it running always after configured.
        // No stop here.
      }

      if (page === "requisitions") {
        ensureMastersLoaded().then(() => {
          initRequisitionFormIfNeeded();
          refreshRequisitionList();
        });
      }
      if (page === "stock") {
        ensureMastersLoaded().then(() => {
          populateWarehouseSelects();
          refreshStockSummary();
        });
      }
      if (page === "transactions") {
        ensureMastersLoaded().then(() => {
          populateTxnDropdowns();
        });
      }
      if (page === "masters") {
        if (!state.config.adminMode) {
          showToast("Admin mode is off", "info");
          navigate("dashboard");
          return;
        }
        ensureMastersLoaded(true).then(() => {
          renderMastersTable();
        });
      }
      if (page === "settings") {
        renderSettingsPageSummary();
      }
    }

    // --------- Polling controller ----------
    function startPolling() {
      if (!isConfigured()) return;
      if (state.ui.polling) return;

      // immediate
      refreshDashboardSnapshot({ silent: true });

      state.ui.polling = setInterval(() => {
        refreshDashboardSnapshot({ silent: true });
      }, 5000);
    }

    function stopPolling() {
      if (state.ui.polling) clearInterval(state.ui.polling);
      state.ui.polling = null;
    }

    // --------- Masters cache ----------
    function loadMastersCacheFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEYS.mastersCache);
        if (!raw) return;
        const obj = JSON.parse(raw);
        if (!obj || !obj.masters) return;
        state.cache.masters = {
          items: Array.isArray(obj.masters.items) ? obj.masters.items : [],
          vendors: Array.isArray(obj.masters.vendors) ? obj.masters.vendors : [],
          warehouses: Array.isArray(obj.masters.warehouses) ? obj.masters.warehouses : [],
          loadedAt: obj.masters.loadedAt ? new Date(obj.masters.loadedAt) : null
        };
      } catch {}
    }

    function saveMastersCacheToStorage() {
      localStorage.setItem(STORAGE_KEYS.mastersCache, JSON.stringify({
        masters: {
          items: state.cache.masters.items,
          vendors: state.cache.masters.vendors,
          warehouses: state.cache.masters.warehouses,
          loadedAt: new Date().toISOString()
        }
      }));
    }

    async function ensureMastersLoaded(force = false) {
      // Use in-memory cache if available
      const have = state.cache.masters.items.length || state.cache.masters.warehouses.length || state.cache.masters.vendors.length;
      if (have && !force) return;

      await reloadMasters(force);
    }

    async function reloadMasters(force = true) {
      if (!isConfigured()) return;

      try {
        showOverlay(true);

        const [itemsRes, vendorsRes, whRes] = await Promise.all([
          api.call("list_items", {}),
          api.call("list_vendors", {}),
          api.call("list_warehouses", {})
        ]);

        const items = Array.isArray(itemsRes.data) ? itemsRes.data : [];
        const vendors = Array.isArray(vendorsRes.data) ? vendorsRes.data : [];
        const warehouses = Array.isArray(whRes.data) ? whRes.data : [];

        state.cache.masters.items = items;
        state.cache.masters.vendors = vendors;
        state.cache.masters.warehouses = warehouses;
        state.cache.masters.loadedAt = new Date();

        saveMastersCacheToStorage();
        populateWarehouseSelects();
        populateTxnDropdowns();
        showToast("Master data loaded", "success");
      } catch (e) {
        showToast("Failed to load masters: " + e.message, "error");
      } finally {
        showOverlay(false);
      }
    }

    // --------- Dashboard ----------
    function adaptDashboardData(data) {
      // Requirement fields:
      // KPI: totalActiveItems, totalOnHand, lowStockLines, lastUpdated
      // tables: lowStockTop20, topIssueTop10
      // status: lastSyncTime, loading spinner, error banner
      // Backend may return different keys; adapt with best-effort.
      const out = {
        totalActiveItems: null,
        totalOnHand: null,
        lowStockLines: null,
        lastUpdated: null,
        lowStockTop20: Array.isArray(data?.lowStockTop20) ? data.lowStockTop20 : null,
        topIssueTop10: Array.isArray(data?.topIssueTop10) ? data.topIssueTop10 : null,
        lastSyncTime: data?.lastSyncTime || data?.server_time || data?.serverTime || null,
      };

      // If backend returned kpi object (common)
      if (data?.kpi) {
        // Try mapping from common variants
        // Our earlier backend sample uses items_total, low_stock_rows
        const k = data.kpi;
        out.totalActiveItems = k.totalActiveItems ?? k.items_active ?? k.items_total ?? null;
        out.totalOnHand = k.totalOnHand ?? k.total_on_hand ?? null;
        out.lowStockLines = k.lowStockLines ?? k.low_stock_lines ?? data.lowStockLines ?? data.low_stock_rows ?? null;
      } else {
        out.totalActiveItems = data?.totalActiveItems ?? null;
        out.totalOnHand = data?.totalOnHand ?? null;
        out.lowStockLines = data?.lowStockLines ?? null;
      }

      out.lastUpdated = data?.lastUpdated || data?.server_time || null;

      return out;
    }

    function computeKpisFallback() {
      // Fallback KPI from masters + stock summary cache
      const items = state.cache.masters.items || [];
      const active = items.filter(x => String(x.active || "").toUpperCase() === "TRUE" || x.active === true).length;

      let totalOnHand = 0;
      let lowStockLines = 0;
      const stock = Array.isArray(state.cache.stockSummary) ? state.cache.stockSummary : [];
      for (const r of stock) {
        const on = toNumber(r.on_hand) || 0;
        totalOnHand += on;
        const min = toNumber(r.effective_minimum_qty ?? r.minimum_qty ?? r.item_minimum_qty) || 0;
        if (on <= min) lowStockLines++;
      }
      return { active, totalOnHand, lowStockLines };
    }

    async function refreshDashboardSnapshot({ silent = false } = {}) {
      if (!isConfigured()) return;

      const errBanner = $("#dashErrorBanner");
      if (!silent) errBanner.classList.add("d-none");

      try {
        const res = await api.call("dashboard_snapshot", {});
        state.cache.dashboard = res.data || {};
        const adapted = adaptDashboardData(state.cache.dashboard);

        // Update sync time
        state.ui.lastSync = new Date();
        $("#dashLastSync").textContent = fmtISO(state.ui.lastSync.toISOString());

        // Update KPIs
        let activeItems = adapted.totalActiveItems;
        let totalOnHand = adapted.totalOnHand;
        let lowStockLines = adapted.lowStockLines;

        // If missing, compute fallback (requires masters/stock summary)
        if (activeItems == null || totalOnHand == null || lowStockLines == null) {
          // ensure masters; do not block; best-effort
          if (!state.cache.masters.items.length) await ensureMastersLoaded(false);
          if (!Array.isArray(state.cache.stockSummary)) await refreshStockSummary({ silent: true });

          const fb = computeKpisFallback();
          activeItems = activeItems ?? fb.active;
          totalOnHand = totalOnHand ?? fb.totalOnHand;
          lowStockLines = lowStockLines ?? fb.lowStockLines;
        }

        $("#kpiActiveItems").textContent = activeItems ?? "-";
        $("#kpiTotalOnHand").textContent = (totalOnHand != null) ? String(Math.round(totalOnHand * 100) / 100) : "-";
        $("#kpiLowStockLines").textContent = lowStockLines ?? "-";
        $("#kpiLastUpdated").textContent = adapted.lastUpdated ? fmtISO(adapted.lastUpdated) : fmtISO(new Date().toISOString());

        // Tables
        renderDashLowStock(adapted.lowStockTop20);
        renderDashTopIssue(adapted.topIssueTop10);

        errBanner.classList.add("d-none");
      } catch (e) {
        if (!silent) {
          errBanner.classList.remove("d-none");
          errBanner.innerHTML = `<i class="bi bi-x-circle me-2"></i>${escapeHTML(e.message)}`;
        }
        $("#dashLastSync").textContent = "-";
      }
    }

    function renderDashLowStock(rows) {
      const tb = $("#dashLowStockTbody");
      const list = Array.isArray(rows) ? rows : [];

      if (!list.length) {
        tb.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">No data</td></tr>`;
        return;
      }

      tb.innerHTML = list.slice(0, 20).map(r => {
        const item = escapeHTML(r.item_code || r.item || "-");
        const wh = escapeHTML(r.warehouse_code || r.warehouse || "-");
        const on = toNumber(r.on_hand ?? r.onHand) ?? 0;
        const min = toNumber(r.minimum_qty ?? r.min ?? r.effective_minimum_qty) ?? 0;
        const cls = on <= min ? "low-stock" : "";
        return `
          <tr class="${cls}">
            <td class="mono">${item}</td>
            <td class="mono">${wh}</td>
            <td class="text-end mono">${escapeHTML(on)}</td>
            <td class="text-end mono">${escapeHTML(min)}</td>
          </tr>`;
      }).join("");
    }

    function renderDashTopIssue(rows) {
      const tb = $("#dashTopIssueTbody");
      const list = Array.isArray(rows) ? rows : [];

      if (!list.length) {
        tb.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-4">No data</td></tr>`;
        return;
      }

      tb.innerHTML = list.slice(0, 10).map(r => `
        <tr>
          <td class="mono">${escapeHTML(r.item_code || r.item || "-")}</td>
          <td class="text-end mono">${escapeHTML(r.qty_issued ?? r.qty ?? "-")}</td>
          <td class="mono">${escapeHTML(r.period || r.range || "-")}</td>
        </tr>
      `).join("");
    }

    // Use stock summary to derive low stock for dashboard if backend lacks it
    async function deriveDashLowStockFromStockSummary() {
      await refreshStockSummary({ silent: true });
      const stock = Array.isArray(state.cache.stockSummary) ? state.cache.stockSummary : [];
      const low = stock
        .map(r => {
          const on = toNumber(r.on_hand) || 0;
          const min = toNumber(r.effective_minimum_qty ?? r.item_minimum_qty ?? 0) || 0;
          return { ...r, _on: on, _min: min, _isLow: on <= min };
        })
        .filter(r => r._isLow)
        .sort((a,b) => (a._on - a._min) - (b._on - b._min))
        .slice(0, 20)
        .map(r => ({
          item_code: r.item_code,
          warehouse_code: r.warehouse_code,
          on_hand: r._on,
          minimum_qty: r._min
        }));
      renderDashLowStock(low);
      showToast("Low stock derived from stock summary", "info");
    }

    // --------- Stock ----------
    async function refreshStockSummary({ silent = false } = {}) {
      if (!isConfigured()) return;

      try {
        if (!silent) showOverlay(true);
        const res = await api.call("get_stock_summary", {});
        state.cache.stockSummary = Array.isArray(res.data) ? res.data : [];
        renderStockTable();
      } catch (e) {
        showToast("Failed to load stock: " + e.message, "error");
      } finally {
        if (!silent) showOverlay(false);
      }
    }

    function populateWarehouseSelects() {
      const whs = state.cache.masters.warehouses || [];

      // Stock filter
      const sel = $("#stockWarehouse");
      if (sel) {
        const cur = sel.value;
        sel.innerHTML = `<option value="">All</option>` + whs.map(w =>
          `<option value="${escapeHTML(w.warehouse_code || "")}">${escapeHTML(w.warehouse_code || "")} - ${escapeHTML(w.warehouse_name || "")}</option>`
        ).join("");
        if (cur) sel.value = cur;
      }
    }

    function renderStockTable() {
      const tb = $("#stockTbody");
      const rows = Array.isArray(state.cache.stockSummary) ? state.cache.stockSummary : [];

      const q = ($("#stockSearch").value || "").trim().toLowerCase();
      const wh = $("#stockWarehouse").value || "";
      const lowOnly = $("#stockLowOnly").checked;

      const filtered = rows.filter(r => {
        const itemCode = String(r.item_code || "").toLowerCase();
        const itemName = String(r.item_name_th || r.name_th || "").toLowerCase();
        const warehouse = String(r.warehouse_code || "");

        if (q && !(itemCode.includes(q) || itemName.includes(q))) return false;
        if (wh && warehouse !== wh) return false;

        const on = toNumber(r.on_hand) || 0;
        const min = toNumber(r.effective_minimum_qty ?? r.item_minimum_qty ?? r.minimum_qty) || 0;
        const isLow = on <= min;

        if (lowOnly && !isLow) return false;
        return true;
      });

      $("#stockRowCount").textContent = String(filtered.length);

      if (!filtered.length) {
        tb.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">No data</td></tr>`;
        return;
      }

      tb.innerHTML = filtered.slice(0, 2000).map(r => {
        const on = toNumber(r.on_hand) || 0;
        const min = toNumber(r.effective_minimum_qty ?? r.item_minimum_qty ?? r.minimum_qty) || 0;
        const isLow = on <= min;
        const itemText = `${escapeHTML(r.item_code || "")} - ${escapeHTML(r.item_name_th || "")}`;
        const whText = `${escapeHTML(r.warehouse_code || "")} - ${escapeHTML(r.warehouse_name || "")}`;
        return `
          <tr class="${isLow ? "low-stock" : ""}">
            <td class="wrap-anywhere"><span class="mono">${escapeHTML(r.item_code || "")}</span><div class="small text-muted">${escapeHTML(r.item_name_th || "")}</div></td>
            <td class="wrap-anywhere"><span class="mono">${escapeHTML(r.warehouse_code || "")}</span><div class="small text-muted">${escapeHTML(r.warehouse_name || "")}</div></td>
            <td class="text-end mono">${escapeHTML(on)}</td>
            <td class="text-end mono">${escapeHTML(min)}</td>
            <td class="mono">${escapeHTML(r.updated_at ? fmtISO(r.updated_at) : "-")}</td>
          </tr>`;
      }).join("");
    }

    // --------- Transactions ----------
    function populateTxnDropdowns() {
      const items = state.cache.masters.items || [];
      const whs = state.cache.masters.warehouses || [];

      const itemOptions = `<option value="">Select item</option>` + items.map(it => {
        const code = escapeHTML(it.item_code || "");
        const name = escapeHTML(it.name_th || it.name_en || "");
        return `<option value="${code}" data-uom="${escapeHTML(it.uom || "")}">${code} - ${name}</option>`;
      }).join("");

      const whOptions = `<option value="">Select warehouse</option>` + whs.map(w => {
        const code = escapeHTML(w.warehouse_code || "");
        const name = escapeHTML(w.warehouse_name || "");
        return `<option value="${code}">${code} - ${name}</option>`;
      }).join("");

      // Receive
      const formR = $("#formReceive");
      formR.item_code.innerHTML = itemOptions;
      formR.warehouse_code.innerHTML = whOptions;

      // Issue
      const formI = $("#formIssue");
      formI.item_code.innerHTML = itemOptions;
      formI.warehouse_code.innerHTML = whOptions;
    }

    function attachTxnUomAutoFill() {
      // When item changes, fill uom if empty
      $("#formReceive").addEventListener("change", (e) => {
        if (e.target.name === "item_code") {
          const opt = e.target.selectedOptions[0];
          const uom = opt ? opt.dataset.uom : "";
          if (uom && !$("#formReceive").uom.value) $("#formReceive").uom.value = uom;
        }
      });
      $("#formIssue").addEventListener("change", (e) => {
        if (e.target.name === "item_code") {
          const opt = e.target.selectedOptions[0];
          const uom = opt ? opt.dataset.uom : "";
          if (uom && !$("#formIssue").uom.value) $("#formIssue").uom.value = uom;
        }
      });
    }

    async function onSubmitReceive(e) {
      e.preventDefault();
      const form = e.target;
      $("#issueInsufficientBanner").classList.add("d-none"); // just in case

      const ok = validateForm(form, {
        qty: v => (toNumber(v) > 0) || "qty ต้องมากกว่า 0",
        created_by: v => !!String(v||"").trim() || "required",
        item_code: v => !!String(v||"").trim() || "required",
        warehouse_code: v => !!String(v||"").trim() || "required",
        uom: v => !!String(v||"").trim() || "required",
      });
      if (!ok) return;

      const tx = {
        ref_no: form.ref_no.value.trim(),
        item_code: form.item_code.value.trim(),
        warehouse_code: form.warehouse_code.value.trim(),
        qty: toNumber(form.qty.value),
        uom: form.uom.value.trim(),
        unit_cost: toNumber(form.unit_cost.value) || 0,
        remark: form.remark.value.trim(),
        created_by: form.created_by.value.trim()
      };

      try {
        showOverlay(true);
        await api.call("create_receipt", { tx, actor: tx.created_by });
        showToast("Receipt created", "success");

        // immediate refresh (requirement)
        await refreshStockSummary({ silent: true });
        await refreshDashboardSnapshot({ silent: true });

        form.reset();
      } catch (e2) {
        showToast("Create receipt failed: " + e2.message, "error");
      } finally {
        showOverlay(false);
      }
    }

    async function onSubmitIssue(e) {
      e.preventDefault();
      const form = e.target;

      const ok = validateForm(form, {
        qty: v => (toNumber(v) > 0) || "qty ต้องมากกว่า 0",
        created_by: v => !!String(v||"").trim() || "required",
        item_code: v => !!String(v||"").trim() || "required",
        warehouse_code: v => !!String(v||"").trim() || "required",
        uom: v => !!String(v||"").trim() || "required",
      });
      if (!ok) return;

      const tx = {
        ref_no: form.ref_no.value.trim(),
        item_code: form.item_code.value.trim(),
        warehouse_code: form.warehouse_code.value.trim(),
        qty: toNumber(form.qty.value),
        uom: form.uom.value.trim(),
        dept: form.dept.value.trim(),
        requester: form.requester.value.trim(),
        remark: form.remark.value.trim(),
        created_by: form.created_by.value.trim()
      };

      try {
        showOverlay(true);
        $("#issueInsufficientBanner").classList.add("d-none");

        await api.call("create_issue", { tx, actor: tx.created_by });
        showToast("Issue created", "success");

        // immediate refresh (requirement)
        await refreshStockSummary({ silent: true });
        await refreshDashboardSnapshot({ silent: true });

        form.reset();
      } catch (e2) {
        // Handle INSUFFICIENT_STOCK (requirement)
        if (String(e2.message || "").startsWith("INSUFFICIENT_STOCK:")) {
          let details = null;
          try {
            details = JSON.parse(e2.message.slice("INSUFFICIENT_STOCK:".length));
          } catch {}
          const onHand = details?.on_hand ?? "-";
          $("#issueInsufficientBanner").classList.remove("d-none");
          $("#issueInsufficientBanner").innerHTML =
            `<i class="bi bi-exclamation-triangle me-2"></i>สต็อกไม่พอ (INSUFFICIENT_STOCK). On-hand ปัจจุบัน: <b class="mono">${escapeHTML(onHand)}</b>`;
          showToast("Insufficient stock", "error");
        } else {
          showToast("Create issue failed: " + e2.message, "error");
        }
      } finally {
        showOverlay(false);
      }
    }

    // --------- Requisitions ----------
    function initRequisitionFormIfNeeded() {
      // Ensure there is at least 1 line
      if (!$("#reqLinesTbody").children.length) addReqLineRow();
    }

    function resetRequisitionForm() {
      $("#formReqHeader").reset();
      $("#reqLinesTbody").innerHTML = "";
      addReqLineRow();
      state.current.requisitionDraft.req_id = null;
      $("#reqCurrentId").textContent = "-";
      $("#reqSubmitSuccess").classList.add("d-none");
      $("#reqSubmitError").classList.add("d-none");
      clearFormValidation($("#formReqHeader"));
    }

    function buildReqLineRowHtml(lineId = cryptoRandomId()) {
      const items = state.cache.masters.items || [];
      const options = `<option value="">Select item</option>` + items.map(it => {
        const code = escapeHTML(it.item_code || "");
        const name = escapeHTML(it.name_th || it.name_en || "");
        const uom = escapeHTML(it.uom || "");
        return `<option value="${code}" data-uom="${uom}">${code} - ${name}</option>`;
      }).join("");

      return `
        <tr data-line-id="${escapeHTML(lineId)}">
          <td>
            <select class="form-select form-select-sm req-line-item" required>
              ${options}
            </select>
            <div class="invalid-feedback">กรุณาเลือก item</div>
          </td>
          <td>
            <input class="form-control form-control-sm text-end req-line-qty" inputmode="decimal" placeholder="0" required />
            <div class="invalid-feedback">qty ต้องมากกว่า 0</div>
          </td>
          <td>
            <input class="form-control form-control-sm req-line-uom" placeholder="uom" required />
            <div class="invalid-feedback">กรุณากรอก uom</div>
          </td>
          <td>
            <input class="form-control form-control-sm req-line-remark" placeholder="remark" />
          </td>
          <td class="text-end">
            <button class="btn btn-outline-danger btn-sm req-line-remove" type="button" title="Remove">
              <i class="bi bi-x-lg"></i>
            </button>
          </td>
        </tr>
      `;
    }

    function addReqLineRow() {
      const tb = $("#reqLinesTbody");
      tb.insertAdjacentHTML("beforeend", buildReqLineRowHtml());
    }

    function cryptoRandomId() {
      // small helper: stable enough for DOM keys
      return "L" + Math.random().toString(16).slice(2, 10);
    }

    function validateEmailIfNotEmpty(v) {
      const s = String(v || "").trim();
      if (!s) return true;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    }

    function validateReqHeaderForm() {
      const form = $("#formReqHeader");
      const rules = {
        dept: v => !!String(v||"").trim() || "required",
        requester: v => !!String(v||"").trim() || "required",
        requester_email: v => validateEmailIfNotEmpty(v) || "invalid email",
        approver_email: v => validateEmailIfNotEmpty(v) || "invalid email",
      };
      return validateForm(form, rules);
    }

    function validateReqLines() {
      const rows = $$("#reqLinesTbody tr");
      let ok = true;

      if (!rows.length) {
        showToast("กรุณาเพิ่มอย่างน้อย 1 line", "error");
        return false;
      }

      for (const tr of rows) {
        const itemSel = $(".req-line-item", tr);
        const qtyInp = $(".req-line-qty", tr);
        const uomInp = $(".req-line-uom", tr);

        // reset
        [itemSel, qtyInp, uomInp].forEach(el => el.classList.remove("is-invalid"));

        const item = String(itemSel.value || "").trim();
        const qty = toNumber(qtyInp.value);
        const uom = String(uomInp.value || "").trim();

        if (!item) { itemSel.classList.add("is-invalid"); ok = false; }
        if (!(qty > 0)) { qtyInp.classList.add("is-invalid"); ok = false; }
        if (!uom) { uomInp.classList.add("is-invalid"); ok = false; }
      }
      if (!ok) showToast("กรุณาตรวจสอบ lines (item/qty/uom)", "error");
      return ok;
    }

    function collectRequisitionPayload() {
      const form = $("#formReqHeader");
      const lines = $$("#reqLinesTbody tr").map(tr => {
        const itemSel = $(".req-line-item", tr);
        const qtyInp = $(".req-line-qty", tr);
        const uomInp = $(".req-line-uom", tr);
        const remInp = $(".req-line-remark", tr);

        return {
          item_code: String(itemSel.value || "").trim(),
          qty: toNumber(qtyInp.value),
          uom: String(uomInp.value || "").trim(),
          remark: String(remInp.value || "").trim()
        };
      });

      return {
        dept: form.dept.value.trim(),
        requester: form.requester.value.trim(),
        requester_email: form.requester_email.value.trim(),
        approver: form.approver.value.trim(),
        approver_email: form.approver_email.value.trim(),
        remark: form.remark.value.trim(),
        lines
      };
    }

    async function saveDraft() {
      $("#reqSubmitSuccess").classList.add("d-none");
      $("#reqSubmitError").classList.add("d-none");

      const okH = validateReqHeaderForm();
      const okL = validateReqLines();
      if (!okH || !okL) return;

      const data = collectRequisitionPayload();

      try {
        showOverlay(true);
        const res = await api.call("create_requisition", data);
        const reqId = res.data?.req_id;
        state.current.requisitionDraft.req_id = reqId || null;
        $("#reqCurrentId").textContent = reqId ? reqId : "-";
        showToast("Draft saved: " + (reqId || ""), "success");

        await refreshRequisitionList({ silent: true });
        await refreshDashboardSnapshot({ silent: true });
      } catch (e) {
        $("#reqSubmitError").classList.remove("d-none");
        $("#reqSubmitError").innerHTML = `<i class="bi bi-x-circle me-2"></i>${escapeHTML(e.message)}`;
        showToast("Save draft failed", "error");
      } finally {
        showOverlay(false);
      }
    }

    async function submitRequisitionFlow() {
      // Ensure draft exists; if not, create draft first then submit.
      const okH = validateReqHeaderForm();
      const okL = validateReqLines();
      if (!okH || !okL) return;

      // Confirm modal opens, actual submit is in btnConfirmSubmitNow handler
      const modal = bootstrap.Modal.getOrCreateInstance($("#modalConfirmSubmit"));
      modal.show();
    }

    async function submitNowConfirmed() {
      const modal = bootstrap.Modal.getInstance($("#modalConfirmSubmit"));
      if (modal) modal.hide();

      $("#reqSubmitSuccess").classList.add("d-none");
      $("#reqSubmitError").classList.add("d-none");

      try {
        showOverlay(true);

        // If no req_id yet, create it
        if (!state.current.requisitionDraft.req_id) {
          const draftRes = await api.call("create_requisition", collectRequisitionPayload());
          state.current.requisitionDraft.req_id = draftRes.data?.req_id || null;
          $("#reqCurrentId").textContent = state.current.requisitionDraft.req_id || "-";
        }

        const reqId = state.current.requisitionDraft.req_id;
        if (!reqId) throw new Error("MISSING_REQ_ID");

        const submittedBy = $("#formReqHeader").requester.value.trim() || "user";
        const res = await api.call("submit_requisition", { req_id: reqId, submitted_by: submittedBy });

        const pdfUrl = res.data?.pdf_url || "";
        const mailedTo = (res.data?.mailedTo || []).join(", ");

        $("#reqSubmitSuccess").classList.remove("d-none");
        $("#reqSubmitSuccess").innerHTML = `
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div>
              <i class="bi bi-check-circle me-2"></i>
              Submit สำเร็จ. สร้าง PDF แล้ว${mailedTo ? ` และส่งเมลไปยัง: <span class="mono">${escapeHTML(mailedTo)}</span>` : ""}.
            </div>
            ${pdfUrl ? `<a class="btn btn-outline-primary btn-sm" target="_blank" rel="noopener" href="${escapeHTML(pdfUrl)}"><i class="bi bi-box-arrow-up-right"></i> Open PDF</a>` : ""}
          </div>
        `;
        showToast("Submitted: " + reqId, "success");

        // immediate refresh (requirement)
        await refreshRequisitionList({ silent: true });
        await refreshDashboardSnapshot({ silent: true });

      } catch (e) {
        // Handle ALREADY_SUBMITTED
        if (e.message === "ALREADY_SUBMITTED") {
          $("#reqSubmitError").classList.remove("d-none");
          $("#reqSubmitError").innerHTML = `<i class="bi bi-info-circle me-2"></i>รายการนี้ถูก Submit ไปแล้วก่อนหน้านี้ (ALREADY_SUBMITTED)`;
          showToast("Already submitted", "info");
        } else {
          $("#reqSubmitError").classList.remove("d-none");
          $("#reqSubmitError").innerHTML = `<i class="bi bi-x-circle me-2"></i>${escapeHTML(e.message)}`;
          showToast("Submit failed", "error");
        }
      } finally {
        showOverlay(false);
      }
    }

    async function refreshRequisitionList({ silent = false } = {}) {
      if (!isConfigured()) return;
      const status = $("#reqFilterStatus").value || "";

      try {
        if (!silent) showOverlay(true);
        const filters = {};
        if (status) filters.status = status;

        const res = await api.call("list_requisitions", { filters });
        const rows = Array.isArray(res.data) ? res.data : [];
        renderRequisitionList(rows);
      } catch (e) {
        showToast("Failed to load requisitions: " + e.message, "error");
      } finally {
        if (!silent) showOverlay(false);
      }
    }

    function renderRequisitionList(rows) {
      const tb = $("#reqListTbody");
      if (!rows.length) {
        tb.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">No data</td></tr>`;
        return;
      }

      tb.innerHTML = rows.slice(0, 500).map(r => {
        const reqId = escapeHTML(r.req_id || "");
        const dept = escapeHTML(r.dept || "");
        const status = escapeHTML(r.status || "");
        const dt = r.req_datetime ? fmtISO(r.req_datetime) : "-";
        const pdf = r.pdf_url ? `<a href="${escapeHTML(r.pdf_url)}" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm"><i class="bi bi-file-earmark-pdf"></i></a>` : "-";
        return `
          <tr class="req-row" role="button" data-req-id="${reqId}">
            <td class="mono">${reqId}</td>
            <td>${dept}</td>
            <td><span class="badge text-bg-secondary">${status}</span></td>
            <td class="mono">${escapeHTML(dt)}</td>
            <td class="text-end">${pdf}</td>
          </tr>
        `;
      }).join("");
    }

    async function openRequisitionDetail(reqId) {
      try {
        showOverlay(true);
        const res = await api.call("get_requisition_detail", { req_id: reqId });
        const header = res.data?.header || {};
        const lines = Array.isArray(res.data?.lines) ? res.data.lines : [];

        $("#reqDetailHeader").innerHTML = renderReqHeaderBlock(header);
        $("#btnReqOpenPdf").classList.toggle("d-none", !header.pdf_url);
        if (header.pdf_url) $("#btnReqOpenPdf").href = header.pdf_url;

        const tb = $("#reqDetailLines");
        if (!lines.length) {
          tb.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">No data</td></tr>`;
        } else {
          tb.innerHTML = lines.map(ln => `
            <tr>
              <td class="mono">${escapeHTML(ln.item_code || "")}</td>
              <td class="text-end mono">${escapeHTML(ln.qty ?? "")}</td>
              <td class="mono">${escapeHTML(ln.uom || "")}</td>
              <td class="wrap-anywhere">${escapeHTML(ln.remark || "")}</td>
            </tr>
          `).join("");
        }

        bootstrap.Modal.getOrCreateInstance($("#modalReqDetail")).show();
      } catch (e) {
        showToast("Failed to load detail: " + e.message, "error");
      } finally {
        showOverlay(false);
      }
    }

    function renderReqHeaderBlock(h) {
      const reqId = escapeHTML(h.req_id || "");
      const dept = escapeHTML(h.dept || "");
      const requester = escapeHTML(h.requester || "");
      const requesterEmail = escapeHTML(h.requester_email || "");
      const status = escapeHTML(h.status || "");
      const dt = h.req_datetime ? escapeHTML(fmtISO(h.req_datetime)) : "-";
      const remark = escapeHTML(h.remark || "");
      const pdfUrl = h.pdf_url ? `<a class="btn btn-outline-primary btn-sm" target="_blank" rel="noopener" href="${escapeHTML(h.pdf_url)}"><i class="bi bi-box-arrow-up-right"></i> Open PDF</a>` : "";

      return `
        <div class="row g-2">
          <div class="col-12 col-lg-8">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div>
                <div class="small text-muted">Req ID</div>
                <div class="mono fs-5">${reqId}</div>
              </div>
              <div>${pdfUrl}</div>
            </div>
            <div class="mt-2 small text-muted">Remark</div>
            <div class="wrap-anywhere">${remark || "-"}</div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="small text-muted">Status</div>
            <div class="mb-2"><span class="badge text-bg-secondary">${status}</span></div>
            <div class="small text-muted">Dept</div>
            <div>${dept}</div>
            <div class="small text-muted mt-2">Requester</div>
            <div>${requester} <span class="text-muted">(${requesterEmail})</span></div>
            <div class="small text-muted mt-2">Datetime</div>
            <div class="mono">${dt}</div>
          </div>
        </div>
      `;
    }

    // --------- Masters (Admin) ----------
    const MASTER_DEFS = {
      items: {
        title: "Items",
        listAction: "list_items",
        upsertAction: "upsert_item",
        idKey: "item_code",
        columns: [
          { key: "item_code", label: "item_code", class: "mono" },
          { key: "name_th", label: "name_th" },
          { key: "uom", label: "uom", class: "mono" },
          { key: "minimum_qty", label: "minimum_qty", class: "text-end mono" },
          { key: "active", label: "active", class: "mono" }
        ],
        form: [
          { key: "item_code", label: "item_code", req: true, type: "text" },
          { key: "name_th", label: "name_th", req: true, type: "text" },
          { key: "name_en", label: "name_en", req: false, type: "text" },
          { key: "category", label: "category", req: false, type: "text" },
          { key: "uom", label: "uom", req: true, type: "text" },
          { key: "catalog", label: "catalog", req: false, type: "text" },
          { key: "default_vendor_code", label: "default_vendor_code", req: false, type: "text" },
          { key: "minimum_qty", label: "minimum_qty", req: false, type: "number" },
          { key: "active", label: "active", req: false, type: "selectBool" },
          { key: "note", label: "note", req: false, type: "text" },
        ]
      },
      vendors: {
        title: "Vendors",
        listAction: "list_vendors",
        upsertAction: "upsert_vendor",
        idKey: "vendor_code",
        columns: [
          { key: "vendor_code", label: "vendor_code", class: "mono" },
          { key: "vendor_name", label: "vendor_name" },
          { key: "phone", label: "phone", class: "mono" },
          { key: "email", label: "email", class: "mono" },
          { key: "active", label: "active", class: "mono" },
        ],
        form: [
          { key: "vendor_code", label: "vendor_code", req: true, type: "text" },
          { key: "vendor_name", label: "vendor_name", req: true, type: "text" },
          { key: "contact_name", label: "contact_name", req: false, type: "text" },
          { key: "phone", label: "phone", req: false, type: "text" },
          { key: "email", label: "email", req: false, type: "email" },
          { key: "active", label: "active", req: false, type: "selectBool" },
        ]
      },
      warehouses: {
        title: "Warehouses",
        listAction: "list_warehouses",
        upsertAction: "upsert_warehouse",
        idKey: "warehouse_code",
        columns: [
          { key: "warehouse_code", label: "warehouse_code", class: "mono" },
          { key: "warehouse_name", label: "warehouse_name" },
          { key: "location", label: "location" },
          { key: "active", label: "active", class: "mono" },
        ],
        form: [
          { key: "warehouse_code", label: "warehouse_code", req: true, type: "text" },
          { key: "warehouse_name", label: "warehouse_name", req: true, type: "text" },
          { key: "location", label: "location", req: false, type: "text" },
          { key: "active", label: "active", req: false, type: "selectBool" },
        ]
      }
    };

    function renderMastersTable() {
      const def = MASTER_DEFS[state.ui.mastersTab];
      const rows = state.cache.masters[state.ui.mastersTab] || [];

      // Thead
      $("#mastersThead").innerHTML = `
        <tr>
          ${def.columns.map(c => `<th class="${escapeHTML(c.class || "")}">${escapeHTML(c.label)}</th>`).join("")}
          <th class="text-end">Actions</th>
        </tr>
      `;

      const tb = $("#mastersTbody");
      if (!rows.length) {
        tb.innerHTML = `<tr><td colspan="${def.columns.length + 1}" class="text-center text-muted py-4">No data</td></tr>`;
        return;
      }

      tb.innerHTML = rows.slice(0, 2000).map(r => `
        <tr>
          ${def.columns.map(c => `<td class="${escapeHTML(c.class || "")} wrap-anywhere">${escapeHTML(r[c.key] ?? "")}</td>`).join("")}
          <td class="text-end">
            <button class="btn btn-outline-primary btn-sm master-edit" data-master="${escapeHTML(state.ui.mastersTab)}" data-id="${escapeHTML(r[def.idKey] || "")}">
              <i class="bi bi-pencil"></i> Edit
            </button>
          </td>
        </tr>
      `).join("");
    }

    function openMasterModal(mode, type, record) {
      const def = MASTER_DEFS[type];
      state.current.masterEdit = { type, mode, record: record ? { ...record } : {} };

      $("#masterModalTitle").textContent = `${mode === "create" ? "Create" : "Edit"} ${def.title}`;
      $("#masterSaveError").classList.add("d-none");
      $("#masterSaveError").innerHTML = "";

      const container = $("#masterFormFields");
      container.innerHTML = def.form.map(f => {
        const val = record ? (record[f.key] ?? "") : (f.key === "active" ? "TRUE" : "");
        const reqClass = f.req ? "req" : "";
        const disabled = (mode === "edit" && f.key === def.idKey) ? "disabled" : "";
        const col = (f.type === "text" || f.type === "email") ? "col-12 col-md-6" : "col-12 col-md-4";

        if (f.type === "selectBool") {
          return `
            <div class="${col}">
              <label class="form-label ${reqClass}">${escapeHTML(f.label)}</label>
              <select class="form-select" name="${escapeHTML(f.key)}" ${f.req ? "required" : ""} ${disabled}>
                <option value="TRUE" ${String(val).toUpperCase()==="TRUE" ? "selected" : ""}>TRUE</option>
                <option value="FALSE" ${String(val).toUpperCase()==="FALSE" ? "selected" : ""}>FALSE</option>
              </select>
              <div class="invalid-feedback">Required</div>
            </div>
          `;
        }

        return `
          <div class="${col}">
            <label class="form-label ${reqClass}">${escapeHTML(f.label)}</label>
            <input class="form-control" name="${escapeHTML(f.key)}" value="${escapeHTML(val)}"
              ${f.req ? "required" : ""} ${disabled}
              type="${f.type === "email" ? "email" : (f.type === "number" ? "text" : "text")}" />
            <div class="invalid-feedback">${f.type === "email" ? "Email ไม่ถูกต้อง" : "Required"}</div>
          </div>
        `;
      }).join("");

      clearFormValidation($("#formMaster"));
      bootstrap.Modal.getOrCreateInstance($("#modalMasterEdit")).show();
    }

    async function saveMaster() {
      const { type, mode } = state.current.masterEdit;
      const def = MASTER_DEFS[type];
      const form = $("#formMaster");

      const rules = {};
      for (const f of def.form) {
        if (f.req) rules[f.key] = v => !!String(v||"").trim() || "required";
        if (f.type === "email") rules[f.key] = v => validateEmailIfNotEmpty(v) || "invalid email";
        if (f.type === "number") rules[f.key] = v => (String(v||"").trim()==="" || toNumber(v) !== null) || "invalid number";
      }

      if (!validateForm(form, rules)) return;

      // collect
      const obj = {};
      def.form.forEach(f => {
        const v = form.elements[f.key]?.value ?? "";
        if (f.type === "number") obj[f.key] = (String(v).trim()==="" ? "" : toNumber(v));
        else obj[f.key] = String(v).trim();
      });

      // Ensure id is upper trimmed
      obj[def.idKey] = String(obj[def.idKey] || "").trim();

      try {
        showOverlay(true);
        const actor = state.config.adminMode ? "admin" : "user";
        const payload = {};
        // Backend can accept {item:{...}} / {vendor:{...}} etc; send both data + typed object to be safe.
        if (type === "items") payload.item = obj;
        if (type === "vendors") payload.vendor = obj;
        if (type === "warehouses") payload.warehouse = obj;
        payload.actor = actor;

        await api.call(def.upsertAction, payload);
        showToast(`${def.title} saved`, "success");

        // Reload masters immediately to refresh dropdowns
        await reloadMasters(true);
        renderMastersTable();
        bootstrap.Modal.getInstance($("#modalMasterEdit")).hide();

        // immediate refresh dashboard (optional)
        await refreshDashboardSnapshot({ silent: true });
      } catch (e) {
        $("#masterSaveError").classList.remove("d-none");
        $("#masterSaveError").innerHTML = `<i class="bi bi-x-circle me-2"></i>${escapeHTML(e.message)}`;
        showToast("Save failed", "error");
      } finally {
        showOverlay(false);
      }
    }

    // --------- Form validation helpers ----------
    function clearFormValidation(form) {
      if (!form) return;
      $$(".is-invalid", form).forEach(el => el.classList.remove("is-invalid"));
      $$(".is-valid", form).forEach(el => el.classList.remove("is-valid"));
    }

    function validateForm(form, rules = {}) {
      let ok = true;

      // Bootstrap style validation
      form.classList.add("was-validated");

      // custom rules
      for (const [name, fn] of Object.entries(rules)) {
        const el = form.elements[name];
        if (!el) continue;
        const v = el.value;
        const res = fn(v);
        const valid = (res === true) || (res === undefined) || (res === null);
        if (!valid) {
          ok = false;
          el.classList.add("is-invalid");
        } else {
          el.classList.remove("is-invalid");
          el.classList.add("is-valid");
        }
      }

      // native required constraints
      if (!form.checkValidity()) ok = false;

      if (!ok) showToast("กรุณาตรวจสอบข้อมูลในฟอร์ม", "error");
      return ok;
    }

    // --------- Event wiring ----------
    function wireEvents() {
      // Mobile nav clicks
      $("#navListMobile").addEventListener("click", (e) => {
        const a = e.target.closest(".nav-link");
        if (!a) return;
        e.preventDefault();
        const page = a.dataset.page;
        if (page === "settings") openSettingsModal(false);
        else navigate(page);
      });

      // Top settings
      $("#btnSettingsTop").addEventListener("click", () => openSettingsModal(false));
      $("#btnSettingsMobile").addEventListener("click", () => openSettingsModal(false));
      $("#btnOpenSettingsBanner").addEventListener("click", () => openSettingsModal(true));
      $("#btnOpenSettingsPage").addEventListener("click", () => openSettingsModal(false));

      // Admin mode switches
      $("#adminModeSwitch").addEventListener("change", (e) => {
        state.config.adminMode = !!e.target.checked;
        saveSettingsToStorage();
        applyAdminModeToUI();
        showToast("Admin mode: " + (state.config.adminMode ? "On" : "Off"), "info");
      });
      $("#adminModeSwitchMobile").addEventListener("change", (e) => {
        state.config.adminMode = !!e.target.checked;
        saveSettingsToStorage();
        applyAdminModeToUI();
        showToast("Admin mode: " + (state.config.adminMode ? "On" : "Off"), "info");
      });

      // Settings form save
      $("#formSettings").addEventListener("submit", async (e) => {
        e.preventDefault();
        const form = e.target;
        clearFormValidation(form);
        hideSettingsMessages();

        if (!validateForm(form, {
          gasUrl: v => !!String(v||"").trim() || "required",
          apiKey: v => !!String(v||"").trim() || "required",
        })) return;

        state.config.gasUrl = form.gasUrl.value.trim();
        state.config.apiKey = form.apiKey.value.trim();
        state.config.adminMode = (form.adminMode.value === "true");
        saveSettingsToStorage();
        applyAdminModeToUI();

        $("#settingsOk").classList.remove("d-none");
        $("#settingsOk").innerHTML = `<i class="bi bi-check-circle me-2"></i>Saved.`;

        setBannerConfigMissing(!isConfigured());
        renderSettingsPageSummary();

        // Start polling now that configured
        if (isConfigured()) startPolling();

        // Attempt load masters
        await reloadMasters(true);
        showToast("Settings saved", "success");
      });

      // Settings test connection
      $("#btnTestConnection").addEventListener("click", async () => {
        // Take current inputs (without saving) for test
        hideSettingsMessages();
        const form = $("#formSettings");
        if (!validateForm(form, {
          gasUrl: v => !!String(v||"").trim() || "required",
          apiKey: v => !!String(v||"").trim() || "required",
        })) return;

        const prev = { ...state.config };
        state.config.gasUrl = form.gasUrl.value.trim();
        state.config.apiKey = form.apiKey.value.trim();

        const ok = await testConnection($("#settingsOk"), $("#settingsFail"));
        if (!ok) {
          // revert if failed
          state.config = prev;
        }
      });

      $("#btnClearSettings").addEventListener("click", () => {
        localStorage.removeItem(STORAGE_KEYS.settings);
        localStorage.removeItem(STORAGE_KEYS.mastersCache);
        state.config = { gasUrl: "", apiKey: "", adminMode: false };
        applyAdminModeToUI();
        setBannerConfigMissing(true);
        showToast("localStorage cleared", "info");
      });

      // Settings page buttons
      $("#btnTestConnectionPage").addEventListener("click", async () => {
        await testConnection($("#settingsTestOk"), $("#settingsTestFail"));
      });
      $("#btnReloadMastersPage").addEventListener("click", async () => {
        await reloadMasters(true);
      });

      // Dashboard refresh
      $("#btnDashboardRefresh").addEventListener("click", async () => {
        await refreshDashboardSnapshot({ silent: false });
      });
      $("#btnLoadStockForDash").addEventListener("click", async () => {
        await deriveDashLowStockFromStockSummary();
      });

      // Stock filters
      $("#btnStockRefresh").addEventListener("click", () => refreshStockSummary());
      $("#stockSearch").addEventListener("input", () => renderStockTable());
      $("#stockWarehouse").addEventListener("change", () => renderStockTable());
      $("#stockLowOnly").addEventListener("change", () => renderStockTable());
      $("#btnStockClear").addEventListener("click", () => {
        $("#stockSearch").value = "";
        $("#stockWarehouse").value = "";
        $("#stockLowOnly").checked = false;
        renderStockTable();
      });

      // Reload masters in multiple pages
      $("#btnReqReloadMasters").addEventListener("click", () => reloadMasters(true));
      $("#btnStockReloadMasters").addEventListener("click", () => reloadMasters(true));
      $("#btnTxnReloadMasters").addEventListener("click", () => reloadMasters(true));
      $("#btnMastersReload").addEventListener("click", () => reloadMasters(true).then(renderMastersTable));
      $("#btnReloadMastersPage").addEventListener("click", () => reloadMasters(true));

      // Transactions forms
      $("#formReceive").addEventListener("submit", onSubmitReceive);
      $("#formIssue").addEventListener("submit", onSubmitIssue);
      $("#btnReceiveClear").addEventListener("click", () => $("#formReceive").reset());
      $("#btnIssueClear").addEventListener("click", () => {
        $("#formIssue").reset();
        $("#issueInsufficientBanner").classList.add("d-none");
      });
      $("#btnTxnRefreshStock").addEventListener("click", () => refreshStockSummary());

      // Requisitions list refresh + filter
      $("#btnReqRefreshList").addEventListener("click", () => refreshRequisitionList());
      $("#reqFilterStatus").addEventListener("change", () => refreshRequisitionList());
      $("#btnAddReqLine").addEventListener("click", addReqLineRow);
      $("#btnSaveDraft").addEventListener("click", saveDraft);
      $("#btnSubmitReq").addEventListener("click", submitRequisitionFlow);
      $("#btnConfirmSubmitNow").addEventListener("click", submitNowConfirmed);

      // Requisition lines event delegation
      $("#reqLinesTbody").addEventListener("click", (e) => {
        const btn = e.target.closest(".req-line-remove");
        if (!btn) return;
        const tr = e.target.closest("tr");
        if (!tr) return;
        tr.remove();
        if (!$("#reqLinesTbody").children.length) addReqLineRow();
      });
      $("#reqLinesTbody").addEventListener("change", (e) => {
        // auto-fill uom when item selected
        const sel = e.target.closest(".req-line-item");
        if (!sel) return;
        const opt = sel.selectedOptions[0];
        const uom = opt ? (opt.dataset.uom || "") : "";
        const tr = sel.closest("tr");
        const uomInp = $(".req-line-uom", tr);
        if (uom && uomInp && !uomInp.value) uomInp.value = uom;
      });

      // Requisition list row click -> detail
      $("#reqListTbody").addEventListener("click", (e) => {
        const tr = e.target.closest(".req-row");
        if (!tr) return;
        const reqId = tr.dataset.reqId;
        if (reqId) openRequisitionDetail(reqId);
      });

      // Masters tab click
      $("#mastersTabs").addEventListener("click", (e) => {
        const a = e.target.closest("a[data-master]");
        if (!a) return;
        e.preventDefault();
        $$("#mastersTabs .nav-link").forEach(x => x.classList.remove("active"));
        a.classList.add("active");
        state.ui.mastersTab = a.dataset.master;
        renderMastersTable();
      });

      // Masters add
      $("#btnAddMaster").addEventListener("click", () => {
        openMasterModal("create", state.ui.mastersTab, null);
      });

      // Masters edit delegation
      $("#mastersTbody").addEventListener("click", (e) => {
        const btn = e.target.closest(".master-edit");
        if (!btn) return;
        const type = btn.dataset.master;
        const def = MASTER_DEFS[type];
        const id = btn.dataset.id;
        const record = (state.cache.masters[type] || []).find(r => String(r[def.idKey] || "") === id);
        openMasterModal("edit", type, record || null);
      });

      // Master save
      $("#btnMasterSave").addEventListener("click", saveMaster);

      // Brand home
      $("#brandHome").addEventListener("click", (e) => { e.preventDefault(); navigate("dashboard"); });

      // Settings page nav click
      $("#btnOpenSettingsTop")?.addEventListener("click", () => openSettingsModal(false));
      $("#btnSettingsTop").addEventListener("click", () => openSettingsModal(false));
      $("#btnSettingsMobile").addEventListener("click", () => openSettingsModal(false));

      // Settings "Settings" menu
      $("#btnOpenSettingsPage").addEventListener("click", () => openSettingsModal(false));
      $("#btnSettingsTop").addEventListener("click", () => openSettingsModal(false));
    }

    // --------- Init ----------
    async function init() {
      loadSettingsFromStorage();
      loadMastersCacheFromStorage();
      applyAdminModeToUI();
      wireEvents();
      attachTxnUomAutoFill();

      // Config gating
      const configured = isConfigured();
      setBannerConfigMissing(!configured);

      // Start on dashboard if configured, else force settings
      if (!configured) {
        navigate("settings");
        openSettingsModal(true);
        return;
      }

      // Update settings summary page
      renderSettingsPageSummary();

      // Preload masters from storage; refresh in background
      populateWarehouseSelects();
      populateTxnDropdowns();

      // Start polling always (requirement)
      startPolling();

      // Initial navigation
      navigate("dashboard");

      // Best-effort refresh masters in background
      reloadMasters(false);
    }

    // --------- Utility buttons behaviors ----------
    $("#btnSettingsTop")?.addEventListener?.("click", () => openSettingsModal(false));

    // Boot
    window.addEventListener("DOMContentLoaded", init);
  </script>

  <!--
  ============================================================================

  README (Deploy on GitHub Pages) - Single file: index.html
  ----------------------------------------------------------------------------
  1) สร้าง GitHub repo ใหม่ (public หรือ private ที่รองรับ Pages)
  2) อัปโหลดไฟล์นี้เป็น "index.html" ไว้ที่ root ของ repo (main branch)
  3) ไปที่ repo: Settings > Pages
     - Source: Deploy from a branch
     - Branch: main
     - Folder: / (root)
     - Save
  4) รอสักครู่ แล้วเปิด URL ที่ GitHub Pages ให้มา

  การตั้งค่าใช้งาน
  ----------------------------------------------------------------------------
  - เปิดหน้าเว็บ แล้วไปที่ Settings (หรือถ้าไม่มี config ระบบจะบังคับเปิด Settings)
  - กรอก:
    - GAS_WEB_APP_URL: URL ของ Google Apps Script Web App (ลงท้ายด้วย /exec)
    - apiKey: API Key (ตามที่ตั้งใน ScriptProperties/CONFIG ของ backend)
  - กด Test Connection (เรียก action="health")
  - กด Save (บันทึกลง localStorage และเริ่ม polling)

  ข้อกำหนดการเรียก API (สำคัญเรื่อง CORS)
  ----------------------------------------------------------------------------
  - ต้องใช้ fetch POST และกำหนด header:
      Content-Type: text/plain;charset=utf-8
  - body เป็น JSON.stringify({ action, data, apiKey })

  ตัวอย่าง payload (สำหรับ debug ด้วย DevTools Console)
  ----------------------------------------------------------------------------
  // Health
  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action: "health", apiKey: "YOUR_KEY", data: {} })
  }).then(r => r.json()).then(console.log);

  // Load dashboard snapshot
  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action: "dashboard_snapshot", apiKey: "YOUR_KEY", data: {} })
  }).then(r => r.json()).then(console.log);

  // Create receipt
  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      action: "create_receipt",
      apiKey: "YOUR_KEY",
      data: { tx: { item_code:"ITM001", warehouse_code:"WH01", qty:10, uom:"ชิ้น", ref_no:"PO-1", created_by:"store" } }
    })
  }).then(r => r.json()).then(console.log);

  // Create issue
  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      action: "create_issue",
      apiKey: "YOUR_KEY",
      data: { tx: { item_code:"ITM001", warehouse_code:"WH01", qty:2, uom:"ชิ้น", ref_no:"ISS-1", created_by:"store" } }
    })
  }).then(r => r.json()).then(console.log);

  // Create requisition
  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      action: "create_requisition",
      apiKey: "YOUR_KEY",
      data: {
        dept:"ICU", requester:"Somchai", requester_email:"somchai@org.com",
        remark:"ขอใช้รอบบ่าย",
        lines:[{ item_code:"ITM001", qty:3, uom:"ชิ้น", remark:"" }]
      }
    })
  }).then(r => r.json()).then(console.log);

  // Submit requisition
  fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({
      action: "submit_requisition",
      apiKey: "YOUR_KEY",
      data: { req_id:"REQ-...", submitted_by:"Somchai" }
    })
  }).then(r => r.json()).then(console.log);

  ============================================================================
  -->
</body>
</html>
